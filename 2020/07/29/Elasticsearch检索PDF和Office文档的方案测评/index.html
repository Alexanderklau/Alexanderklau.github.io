<!DOCTYPE html>


<html lang="zh-CN" >


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Elasticsearch检索PDF和Office文档的方案测评 |  Yemilice
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/favicon.ico" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

<link rel="alternate" href="/atom.xml" title="Yemilice" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-Elasticsearch检索PDF和Office文档的方案测评" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Elasticsearch检索PDF和Office文档的方案测评
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/07/29/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/" class="article-date">
  <time datetime="2020-07-29T06:02:32.000Z" itemprop="datePublished">2020-07-29</time>
</a>
      
      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">13 分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这段时间主要攻关了一下Elasticsearch的一些特性，发觉Elasticsearch还是个挺牛逼的玩意儿，我以前经常用它存日志，还没想着拿来存别的东西，一般不都SQL嘛，但是我看了一下现在流行的检索方案，基本都是elasticsearch做检索引擎，说明这个东西经历了时间的考研，用了的人都说好。</p>
<p>我以前拿Elasticsearch来存储日志，搜东西相当方便，定义好检索语句直接走你，但是我看百度文库搜索，还可以做到docx，pdf关键字检索并且高亮，这个就很厉害了，这两天紧急攻关了一下，把自己踩的坑和收获记录下来，方便未来自己复习/查看</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>老样子，写任何blog，我都要做需求分析，这样才能更好的进行开发和写作。</p>
<h3 id="我们要干嘛"><a href="#我们要干嘛" class="headerlink" title="我们要干嘛"></a>我们要干嘛</h3><p>我们要实现一个elasticsearch检索pdf和office家族文件的功能，并且要对pdf/office文件进行一个全文检索，也就是说，搜索“Yemilice”，不仅仅是标题含有“Yemilice”，内容含有“Yemilice”的文件也要检索出来，并且给人家高亮。</p>
<h3 id="我们的工作环境"><a href="#我们的工作环境" class="headerlink" title="我们的工作环境"></a>我们的工作环境</h3><p><strong>底层环境</strong></p>
<p>Centos7服务器</p>
<p><strong>Elasticsearch的版本</strong></p>
<p>6.3.2</p>
<h2 id="现有的检索解决方案"><a href="#现有的检索解决方案" class="headerlink" title="现有的检索解决方案"></a>现有的检索解决方案</h2><p>经过我的发力工作（Google/baidu）,现在市面上流行这么几种方案</p>
<ol>
<li>Elasticsearch 官方插件 <strong>ingest-attachment</strong></li>
<li>第三方开源服务 <strong>fscrawler</strong></li>
<li>大数据平台 <strong>Ambari</strong></li>
</ol>
<p>接下来麻烦事儿就来了，这三个方案，到底选哪个？才能更那啥呢，我倒不如把他们一一实现一遍，然后给大家伙儿展示一拨，然后最后再选一个合适的不就得了嘛！</p>
<p>没事儿，苦了我一个，幸福大家伙儿呗！</p>
<h2 id="1-ingest-attachment插件"><a href="#1-ingest-attachment插件" class="headerlink" title="1. ingest-attachment插件"></a>1. ingest-attachment插件</h2><p>这玩意儿是什么呢，说白了就是elasticsearch官方给大家贡献的一个插件，支持你把docx，pdf之类的东西导入到es当中。当然要你自己手动去实现接口。</p>
<h3 id="1-1-ingest-attachment插件的安装"><a href="#1-1-ingest-attachment插件的安装" class="headerlink" title="1.1 ingest-attachment插件的安装"></a>1.1 ingest-attachment插件的安装</h3><p>首先，我认为你现在在CN境内，你就<strong>不要</strong>看网上那些老哥教的直接执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-plugin install ingest-attachment</span><br></pre></td></tr></table></figure>

<p>这样你会等到地老天荒也下载不完，现在你需要的就是下个离线包，然后再去安装</p>
<p>下载离线包的网址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://artifacts.elastic.co/downloads/elasticsearch-plugins/ingest-attachment/ingest-attachment-6.3.2.zip.</span><br></pre></td></tr></table></figure>
<p>注意一点啊，一定要注意！你的ingest-attachment版本必须和你的elasticsearch一致，你要强行不听我的，到时候费心思整完，弄不好，那你就只能来颗华子再来一次了。</p>
<p>安装离线包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-plugin install ingest-attachment-6.3.2.zip</span><br></pre></td></tr></table></figure>
<p>没报错就说明你安上了，不放心的话</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-plugin list</span><br></pre></td></tr></table></figure>
<p>看一下，有这个插件了说明你已经有了这个插件</p>
<h3 id="1-2-ingest-attachment插件的基础使用"><a href="#1-2-ingest-attachment插件的基础使用" class="headerlink" title="1.2 ingest-attachment插件的基础使用"></a>1.2 ingest-attachment插件的基础使用</h3><p>看了下官网，其实他的逻辑很简单，整个管道，你把你的pdf/doc什么的给转成base64，然后通过管道把base64传进去，es会把所有的东西给你安排好。</p>
<p>我现在简单的整了个pdf，名字就叫1.pdf，现在开始吧。</p>
<p><strong>抽取管道的函数编写，这里是告诉es，创建一个抽取管道pipeline</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"localhost:9200/_ingest/pipeline/attachment"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string"> "description" : "Extract attachment information",</span></span><br><span class="line"><span class="string"> "processors":[</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">    "attachment":&#123;</span></span><br><span class="line"><span class="string">        "field":"data",</span></span><br><span class="line"><span class="string">        "indexed_chars" : -1,</span></span><br><span class="line"><span class="string">        "ignore_missing":true</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string"> &#125;,</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">     "remove":&#123;"field":"data"&#125;</span></span><br><span class="line"><span class="string"> &#125;]&#125;'</span></span><br></pre></td></tr></table></figure>

<p><strong>创建一个index（表），名字叫pdf，设定1个分片（单节点，当然你自己可以改）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'127.0.0.1:9200/pdf'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">-d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "settings": &#123;</span></span><br><span class="line"><span class="string">        "index": &#123;</span></span><br><span class="line"><span class="string">            "number_of_shards": 1,</span></span><br><span class="line"><span class="string">            "number_of_replicas": 0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>

<p><strong>将pdf转为base64编码，然后上传到elasticsearch当中</strong></p>
<p>这里网上那个方法是直接perl调base64，我这里一直报错，如果和我一样的老哥，用我下面给得另一种方法</p>
<p>方法1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'10.0.7.234:9200/pdf/pdf/1?pipeline=attachment'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">-d <span class="string">'&#123;  "data":" '</span>`base64 -w 0 /root/pdf/pdf.pdf | perl -pe<span class="string">'s/\n/\\n/g'</span>`<span class="string">'"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>

<p>方法2</p>
<p>直接导入base64码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'10.0.7.234:9200/pdf/pdf/1?pipeline=attachment'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">-d <span class="string">'&#123;  "data":"JVBERi0xLjcNCiW1tbW1DQoxIDAgb2JqDQo8PC9UeXBlL0NhdGFsb2cvUGFnZXMgMiAwIFIvTGFuZyh6aC1DTikgL1N0cnVjdFRyZWVSb290IDE1IDAgUi9NYXJrSW5mbzw8L01hcmtlZCB0cnVlPj4vTWV0YWRhdGEgMzMgMCBSL1ZpZXdlclByZWZlcmVuY2VzIDM0IDAgUj4+DQplbmRvYmoNC......（这里我不展示完了）"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>

<p>现在去查看index（表）</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/1.jpg" alt></p>
<p>显示了作者，之类的杂七杂八信息，而content就是详细的全文，可以直接搜索，因为有我的大名我就马赛克了。。</p>
<p>这就导入了，搜索也是按一般的搜索方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET pdf/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"attachment.content"</span>: <span class="string">"pdf"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-ingest-attachment插件的性能评测"><a href="#1-3-ingest-attachment插件的性能评测" class="headerlink" title="1.3 ingest-attachment插件的性能评测"></a>1.3 ingest-attachment插件的性能评测</h3><p><strong>测试导入PDF（10M大小，无图片）</strong></p>
<p>base64命令在perl中执行了大概2s左右，</p>
<p>并且CPU/内存 在转换-&gt;存储这个阶段，占用了</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/2.jpg" alt></p>
<p>可见在抽取文本 ——&gt; 传输存储入es的时候，插件可能会占用少部分CPU</p>
<p><strong>测试导入PDF（40M大小，图片/文字混用）</strong></p>
<p>base64命令在perl中执行了大概10s左右，并且还返回了错误（perl长度过大的错误）</p>
<p>并且CPU/内存 在转换-&gt;存储这个阶段，占用了</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/3.jpg" alt></p>
<p>在图片/文字混用并且pdf文件比较大的情况下，内存占用较大，并且返回较慢，这里需要注意，并且解析的base64会直接塞到系统内存当中，如果做多文件抽取，可能会有CPU/内存占用较大的情况出现。</p>
<h3 id="1-4-ingest-attachment插件的优缺点"><a href="#1-4-ingest-attachment插件的优缺点" class="headerlink" title="1.4 ingest-attachment插件的优缺点"></a>1.4 ingest-attachment插件的优缺点</h3><p>优点： </p>
<ol>
<li>安装方便，只需要下载zip安装包，调用elasticsearch本身自带的安装模块即可</li>
<li>使用方便，编辑一条管道抽取命令，可以直接利用linux的base64命令转码存入elasticsearch中</li>
<li>支持的格式比较多，支持ppt，pdf，doc，docx，xls等office常用的办公软件格式导入到elasticsearch当中。</li>
<li>导入后的文档可以直接输入中文进行检索</li>
</ol>
<p>缺点：</p>
<ol>
<li>大文件支持不够，如果超过100M的pdf，base64转码将比较缓慢，并且，存入到elasticsearch中的数据也十分庞大</li>
<li>必须要将文件下载到本地，然后必须进行base64转码才可以存到elasticsearch中，等于说，必须要实体文件，因为需要base64转码，如果文件在对象存储/云上，那就不可以这么操作了</li>
<li>对于pdf，doc中含有图片的情况，没有办法将图片中文文字识别出来，而且如果出现图片较多的情况，转码较慢，含有特殊字符的base64码导入也会无法识别。</li>
</ol>
<h3 id="1-5-ingest-attachment插件的使用场景"><a href="#1-5-ingest-attachment插件的使用场景" class="headerlink" title="1.5 ingest-attachment插件的使用场景"></a>1.5 ingest-attachment插件的使用场景</h3><ol>
<li>存储的文件不那么大的情况</li>
<li>存储的文件大部分都是纯文字的情况</li>
<li>存储的文件全文搜索精准度要求不那么高</li>
</ol>
<h2 id="2-fscrawler服务"><a href="#2-fscrawler服务" class="headerlink" title="2. fscrawler服务"></a>2. fscrawler服务</h2><p>一个类似filebeat的监控服务，监控某个文件夹下面的文档，定时去遍历一次，如果发现了新添加的文档则会直接写入到elasticsearch当中。</p>
<h3 id="2-1-fscrawler安装"><a href="#2-1-fscrawler安装" class="headerlink" title="2.1 fscrawler安装"></a>2.1 fscrawler安装</h3><p>首先非常重要的一点，确定你的elasticseach版本，</p>
<p>如果你的版本 &lt;= 6.3.2，那你需要下载2.5 版本的fscrawler，这个非常重要，否则是无法启动任务的！！！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://repo1.maven.org/maven2/fr/pilato/elasticsearch/crawler/fscrawler/2.5/fscrawler-2.5.zip</span><br></pre></td></tr></table></figure>

<p>如果你的版本 &gt; 6.3.2, 你就可以随意选择2.6，2.7的fscrawler了，区别还是有一些的，后面我会说。</p>
<p>下载下来，解压，这个你肯定会</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip fscrawler-2.5.zip</span><br></pre></td></tr></table></figure>

<p>尝试跑一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./fscrawler</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">03:53:39,425 INFO  [f.p.e.c.f.c.FsCrawler] No job specified. Here is the list of existing <span class="built_in">jobs</span>:</span><br><span class="line">03:53:39,433 INFO  [f.p.e.c.f.c.FsCrawler] [1] - work01</span><br><span class="line">03:53:39,433 INFO  [f.p.e.c.f.c.FsCrawler] Choose your job [1-1]...</span><br></pre></td></tr></table></figure>
<p>说明能用</p>
<h3 id="2-2-fscrawler的使用方法"><a href="#2-2-fscrawler的使用方法" class="headerlink" title="2.2 fscrawler的使用方法"></a>2.2 fscrawler的使用方法</h3><p>启动服务</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/4.png" alt></p>
<p>查看一下文件结构</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/5.png" alt></p>
<p>编写指定的json去进行服务监控/设置</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/6.png" alt></p>
<p>现在导入一个1.pdf的文件</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/7.png" alt></p>
<p>监控到fscrawler发生了变化</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/9.png" alt></p>
<p>去查看elasticsearch，已经有了这个1.pdf的文件</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/8.png" alt></p>
<h3 id="2-3-fscrawler的配置文件解析（彩蛋）"><a href="#2-3-fscrawler的配置文件解析（彩蛋）" class="headerlink" title="2.3 fscrawler的配置文件解析（彩蛋）"></a>2.3 fscrawler的配置文件解析（彩蛋）</h3><p>一般来说，咱们fscrawler的配置文件都是默认在/root/.fscrawler/_settings.json下的，但是，如果你的es版本高于6.3.2，你下载的fs版本不是2.5，那么你的settings文件将会是yaml格式的，不知道是不是在向filebeat看齐。。。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // 工程名</span><br><span class="line">  "name" : "work01",  </span><br><span class="line">  "fs" : &#123;</span><br><span class="line">    //   监控的文件夹</span><br><span class="line">    "url" : "/tmp/es",</span><br><span class="line">    // 多长时间去扫描一次</span><br><span class="line">    "update_rate" : "30s",</span><br><span class="line">    // 添加例外</span><br><span class="line">    "excludes" : [ "*/~*" ],</span><br><span class="line">    "json_support" : false,</span><br><span class="line">    // 将文件名作为ID</span><br><span class="line">    "filename_as_id" : false,</span><br><span class="line">    // 文件大小添加</span><br><span class="line">    "add_filesize" : true,</span><br><span class="line">    // 同步删除</span><br><span class="line">    "remove_deleted" : true,</span><br><span class="line">    "add_as_inner_object" : false,</span><br><span class="line">    "store_source" : false,</span><br><span class="line">    "index_content" : true,</span><br><span class="line">    "attributes_support" : false,</span><br><span class="line">    "raw_metadata" : true,</span><br><span class="line">    "xml_support" : false,</span><br><span class="line">    "index_folders" : true,</span><br><span class="line">    "lang_detect" : false,</span><br><span class="line">    "continue_on_error" : false,</span><br><span class="line">    // ocr开启</span><br><span class="line">    "pdf_ocr" : true,</span><br><span class="line">    "ocr" : &#123;</span><br><span class="line">        // ocr英文</span><br><span class="line">      "language" : "eng"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "elasticsearch" : &#123;</span><br><span class="line">    "nodes" : [ &#123;</span><br><span class="line">        // esip</span><br><span class="line">      "host" : "127.0.0.1",</span><br><span class="line">      "port" : 9200,</span><br><span class="line">      "scheme" : "HTTP"</span><br><span class="line">    &#125; ],</span><br><span class="line">    "bulk_size" : 100,</span><br><span class="line">    "flush_interval" : "5s",</span><br><span class="line">    "byte_size" : "10mb"</span><br><span class="line">  &#125;,</span><br><span class="line">  "rest" : &#123;</span><br><span class="line">    "scheme" : "HTTP",</span><br><span class="line">    "host" : "127.0.0.1",</span><br><span class="line">    "port" : 8080,</span><br><span class="line">    "endpoint" : "fscrawler"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-fscrawler的性能评测"><a href="#2-4-fscrawler的性能评测" class="headerlink" title="2.4 fscrawler的性能评测"></a>2.4 fscrawler的性能评测</h3><p>首先走一波导入文件测试</p>
<p><strong>导入1M纯文字的pdf</strong></p>
<p>瞬间就完成了，速度极快</p>
<p>elasticsearch监控信息如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/10.jpg" alt></p>
<p>Fscrawler占用CPU/内存如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/11.jpg" alt></p>
<p><strong>导入10M纯文字的pdf</strong></p>
<p>瞬间就完成了，速度极快</p>
<p>elasticsearch监控信息如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/10.jpg" alt></p>
<p>Fscrawler占用CPU/内存如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/11.jpg" alt></p>
<p><strong>导入40M文字图片都有的pdf</strong></p>
<p>速度很快，但是CPU占比一下就上去了，es还是没有什么变化</p>
<p>elasticsearch监控信息如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/13.jpg" alt></p>
<p>Fscrawler占用CPU/内存如下</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/12.jpg" alt></p>
<h3 id="2-5-fscrawler的优缺点"><a href="#2-5-fscrawler的优缺点" class="headerlink" title="2.5 fscrawler的优缺点"></a>2.5 fscrawler的优缺点</h3><p>fscrawler我其实是比较推荐的</p>
<p><strong>优点</strong></p>
<ol>
<li>支持的格式很多，并且自带OCR，如果内存/CPU富裕的情况可以直接上OCR，识别率虽然不是特别高但也够用了。</li>
<li>导入不用自己动手，设置好配置之后，fscrawler会帮你创建好index，然后自动导入文件</li>
<li>支持文件过滤，如果监控的文件夹里面闲杂文件比较多可以写正则过滤掉</li>
<li>CPU/内存占比比较低，我是用的自己的虚拟机，导入40Mpdf完全无问题，CPU占比上去了一瞬间就降下来了。</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>结合我们的使用场景，我们的文件在远端，需要下载下来，下载到指定文件夹，但是下载到指定文件夹后，fscrawler不会马上导入，是去定时扫描，下载到本地的话可能会把系统盘内存撑满，加快扫描时间会让CPU占比上升</li>
<li>安装部署比较麻烦，需要自己写service，自己写维护</li>
<li>配置文件需要自己定义，容错有问题，如果es down机，原有的文件发送一遍失败之后，不会继续发送</li>
</ol>
<h2 id="3-Ambari服务"><a href="#3-Ambari服务" class="headerlink" title="3. Ambari服务"></a>3. Ambari服务</h2><p>这个有个很奇葩的点，是要Es去依赖它，而不是它依赖Es，这东西本身是做大数据的！我感觉咱都有Es了还要啥自行车！</p>
<p>这个是做大数据用的，安装一个大概1个多G，但是功能比较全面，支持各种大文件导入，还支持图片文字的读取，自动分词之类的，其实还是很好用。</p>
<h3 id="3-1-使用一波Ambari"><a href="#3-1-使用一波Ambari" class="headerlink" title="3.1 使用一波Ambari"></a>3.1 使用一波Ambari</h3><p>Ambari的安装就不在这里介绍了。。这个安装比较复杂，但是网上大部分都是docker集成的，我们现在的环境没有docker，所以我只有手动安装了，在我的机器已经安上了，现在需要安装Ambari的Elasticsearch插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://community.hortonworks.com/storage/attachments/87416-elasticsearch-mpack-2600-9.tar.gz</span><br></pre></td></tr></table></figure>

<p>安装mpack</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server install-mpack --mpack=/path/to/87416-elasticsearch-mpack-2600-9.tar.gz --verbose</span><br></pre></td></tr></table></figure>

<p>重启ambari-server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server restart</span><br></pre></td></tr></table></figure>

<p>在ambari-server 上部署elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --user admin:admin -i -H <span class="string">'X-Requested-By: ambari'</span> -X GET <span class="string">"http://ambari.server:8080/api/v1/clusters/<span class="variable">$cluster_name</span>/configurations?type=cluster-env"</span></span><br></pre></td></tr></table></figure>

<p>启动elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart elasticsearch</span><br></pre></td></tr></table></figure>

<p>现在可以在Ambari的管理页面看到es服务器了</p>
<p><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/14.jpg" alt></p>
<p>设置ambar的配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my-files:</span></span><br><span class="line"><span class="attr">    depends_on:</span> </span><br><span class="line"><span class="attr">      serviceapi:</span> </span><br><span class="line"><span class="attr">        condition:</span> <span class="string">service_healthy</span> </span><br><span class="line"><span class="attr">    image:</span> <span class="string">ambar/ambar-local-crawler</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">internal_network</span></span><br><span class="line"><span class="attr">    expose:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8082"</span></span><br><span class="line"><span class="attr">    environment:</span>      </span><br><span class="line"><span class="bullet">      -</span> <span class="string">name=my-files</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreFolders=**/ForSharing/**</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreExtensions=.&#123;exe,dll,rar&#125;</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreFileNames=*backup*</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">maxFileSize=15mb</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/media/Docs:/usr/data</span></span><br></pre></td></tr></table></figure>

<p>现在尝试导入一个PDF</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://ambar/api/files/Books/1984-george_orwell.pdf \</span><br><span class="line">  -H <span class="string">'content-type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW'</span> \</span><br><span class="line">  -F 1984-george_orwell.rtf=@1984-george_orwell.pdf</span><br></pre></td></tr></table></figure>

<p>这下就完成了导入</p>
<h3 id="3-2-高级特性"><a href="#3-2-高级特性" class="headerlink" title="3.2 高级特性"></a>3.2 高级特性</h3><p><strong>监控S3对象存储</strong></p>
<p>设定ak，sk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> ACCESS_KEY_ID:SECRET_ACCESS_KEY &gt;  ~/.passwd-s3fs</span><br><span class="line">chmod 600  ~/.passwd-s3fs</span><br></pre></td></tr></table></figure>

<p>挂载s3 bucket</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/s3-bucket</span><br></pre></td></tr></table></figure>

<p>添加挂载到fstab中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mybucket /mnt/s3-bucket fuse.s3fs _netdev,allow_other 0 0</span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my-files:</span></span><br><span class="line"><span class="attr">    depends_on:</span> </span><br><span class="line"><span class="attr">      serviceapi:</span> </span><br><span class="line"><span class="attr">        condition:</span> <span class="string">service_healthy</span> </span><br><span class="line"><span class="attr">    image:</span> <span class="string">ambar/ambar-local-crawler</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">internal_network</span></span><br><span class="line"><span class="attr">    expose:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8082"</span></span><br><span class="line"><span class="attr">    environment:</span>      </span><br><span class="line"><span class="bullet">      -</span> <span class="string">name=my-files</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreFolders=**/ForSharing/**</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreExtensions=.&#123;exe,dll,rar&#125;</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ignoreFileNames=*backup*</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">maxFileSize=15mb</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/media/Docs:/mnt/s3-bucket</span></span><br></pre></td></tr></table></figure>

<p><strong>OCR文件识别</strong></p>
<p>ambari自带强势的ocr识别，可以识别多种文字/字母/格式的文件，但是需要富裕的CPU和内存</p>
<h3 id="3-3-可能会出现的问题"><a href="#3-3-可能会出现的问题" class="headerlink" title="3.3 可能会出现的问题"></a>3.3 可能会出现的问题</h3><p><strong>优点</strong></p>
<ol>
<li>它可以很好地处理大文件（&gt; 100 MB）</li>
<li>它从PDF中提取内容（即使格式不佳并带有嵌入式图像），并对图像进行OCR</li>
<li>它为用户提供了简单易用的REST API和WEB UI</li>
<li>部署非常容易（感谢Docker）</li>
<li>它是根据Fair Source 1 v0.9许可开源的</li>
<li>开箱即用地为用户提供解析和即时搜索体验。</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>部署可能会相当麻烦，没有docker部署，单独部署的话配置比较复杂</li>
<li>OCR会占用大量的CPU/内存</li>
<li>如果不是大数据，有些大材小用了</li>
</ol>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>我都分析成这样了，该用哪个，心里是不是有点数了，其实很简单</p>
<p>当你的pdf/doc文件不大的情况下，上ingest-attachment插件</p>
<p>当你的文件经常发生变动，上fscrawler</p>
<p>当你是大数据老哥，上Ambari</p>
<p>今天的文章就到这，憋了个大的，如果帮到你，我很开心。</p>
<p>end</p>
<p>2020-07-29</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong>
              本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://yemilice.com/2020/07/29/Elasticsearch%E6%A3%80%E7%B4%A2PDF%E5%92%8COffice%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E6%A1%88%E6%B5%8B%E8%AF%84/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF/" rel="tag">其他技术</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF/" rel="tag">前后端</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/08/10/%E5%87%BA%E5%9F%83%E5%8F%8A%E8%AE%B0-%E6%99%AE%E9%80%9A%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E4%B9%B0%E6%88%BF%E4%B9%8B%E8%B7%AF/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            出埃及记_普通程序员的买房之路
          
        </div>
      </a>
    
    
      <a href="/2020/07/28/Grow-Up/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Grow_Up</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'j2C0ImEnKI1K2lhbIinl34tn-gzGzoHsz',
        app_key: 'BXI6KlgeojX4R82TLkdGxsKJ',
        path: window.location.pathname,
        notify: 'false',
        verify: 'false',
        avatar: 'monsterid',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2019-2022
        Yemilice lau
      </li>
      <li>
        
        Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <span>
  <i>PV:<span id="busuanzi_value_page_pv"></span></i>
  <i>UV:<span id="busuanzi_value_site_uv"></span></i>
</span>
        
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/avatar.jpg" alt="Yemilice"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/">杂七杂八</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF/">前后端</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF/">其他技术</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E7%AE%97%E6%B3%95/">算法</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E9%BB%91%E7%A7%91%E6%8A%80/">黑科技</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E8%AF%B4%E5%94%B1%E4%B9%8B%E8%B7%AF/">说唱之路</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E7%BC%96%E6%9B%B2%E7%9B%B8%E5%85%B3/">编曲相关</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>觉得帮到你了么？赏我点儿~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/aipay.png">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://blog-1256169066.cos.ap-chengdu.myqcloud.com/wechat.png">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['书写仙路物语', '把野果咽入肚里', '梦里面咒语念几遍就会颠覆物理'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
  }

</script>



<script src="/js/tocbot.min.js"></script>
<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>




<script src="/js/busuanzi-2.3.pure.min.js"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>


<!-- 复制 -->

  <link rel="stylesheet" href="/css/clipboard.css">
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




    
  </div>
</body>

</html>